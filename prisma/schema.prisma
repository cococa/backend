generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum MembershipPlan {
  FREE
  PRO
  TEAM
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  CANCELED
  TRIALING
}

enum DataSourceType {
  NOTION
  CSV_FILE
  EXCEL_FILE
  MANUAL_TABLE
  EXTERNAL_API
  THIRD_PARTY
}

enum PublishAccess {
  PUBLIC
  PASSWORD
  PRIVATE
}

enum BillingEventType {
  MEMBERSHIP_CREATED
  MEMBERSHIP_UPDATED
  MEMBERSHIP_CANCELED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  MANUAL_GRANT
}

model User {
  /// User primary key, generated by cuid.
  id              String           @id @default(cuid())
  /// External auth provider user id, reserved for future auth integration.
  authUserId      String           @unique
  /// User email address, unique in the system.
  email           String           @unique
  /// Display name shown in product UI.
  name            String?
  /// Avatar image URL.
  avatar          String?
  /// Preferred timezone used for scheduling and display.
  timezone        String?          @default("Asia/Shanghai")
  /// Preferred locale used for UI and formatting.
  locale          String?          @default("zh-CN")
  /// Record creation time.
  createdAt       DateTime         @default(now())
  /// Record last update time, maintained by Prisma.
  updatedAt       DateTime         @updatedAt
  /// Membership records owned by the user.
  memberships     Membership[]
  /// Chart projects created by the user.
  projects        ChartProject[]
  /// Structured data source definitions owned by the user.
  dataSources     DataSource[]
  /// Published share records created by the user.
  publishedCharts PublishedChart[]
  /// Billing and membership event logs for the user.
  billingEvents   BillingEvent[]
}

model Membership {
  /// Membership primary key, generated by cuid.
  id          String            @id @default(cuid())
  /// Owner user id.
  userId      String
  /// Subscription plan type.
  plan        MembershipPlan    @default(FREE)
  /// Current membership lifecycle status.
  status      MembershipStatus  @default(ACTIVE)
  /// Membership effective start time.
  startAt     DateTime          @default(now())
  /// Membership end time when expired or canceled.
  endAt       DateTime?
  /// Extra billing or plan metadata stored as JSON.
  metaJson    Json?
  /// Record creation time.
  createdAt   DateTime          @default(now())
  /// Record last update time, maintained by Prisma.
  updatedAt   DateTime          @updatedAt
  /// Owning user relation.
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// Billing events associated with this membership.
  billingLogs BillingEvent[]

  @@index([userId, status])
}

model DataSource {
  /// Data source primary key, generated by cuid.
  id           String       @id @default(cuid())
  /// Owner user id.
  userId       String
  /// Unified data source category, e.g. NOTION, CSV_FILE, EXCEL_FILE.
  type         DataSourceType
  /// Display name shown in picker and project lists.
  name         String
  /// Optional description of this data source.
  description  String?
  /// Unified source configuration JSON.
  /// Examples:
  /// - Notion: { "pageId": "xxx" }
  /// - CSV: { "storageProvider": "supabase", "bucket": "chart-data", "path": "users/u1/file.csv" }
  sourceJson   Json
  /// Field metadata JSON used for field inference and UI mapping.
  /// Recommended shape:
  /// {
  ///   "fields": [
  ///     { "key": "id", "type": "number" },
  ///     { "key": "name", "type": "string" }
  ///   ]
  /// }
  fieldSchemaJson Json?
  /// Optional preview/sample data JSON for fast inspection.
  previewJson  Json?
  /// Soft delete flag.
  isDeleted    Boolean      @default(false)
  /// Record creation time.
  createdAt    DateTime     @default(now())
  /// Record last update time, maintained by Prisma.
  updatedAt    DateTime     @updatedAt
  /// Owning user relation.
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// Projects bound to this data source.
  projects     ChartProject[]

  @@index([userId, type, isDeleted])
}

model ChartProject {
  /// Project primary key, generated by cuid.
  id                 String            @id @default(cuid())
  /// Owner user id.
  userId             String
  /// Optional bound data source id.
  dataSourceId       String?
  /// Project display name.
  name               String
  /// Optional project description.
  description        String?
  /// Current chart type used by the project.
  chartType          String
  /// Core chart specification/configuration JSON.
  configJson         Json
  /// Optional chart theme configuration JSON.
  themeJson          Json?
  /// Optional publish settings JSON.
  publishOptionsJson Json?
  /// Soft delete flag.
  isDeleted          Boolean           @default(false)
  /// Record creation time.
  createdAt          DateTime          @default(now())
  /// Record last update time, maintained by Prisma.
  updatedAt          DateTime          @updatedAt
  /// Owning user relation.
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// Optional data source relation.
  dataSource         DataSource?       @relation(fields: [dataSourceId], references: [id], onDelete: SetNull)
  /// Published share records generated from this project.
  publishedCharts    PublishedChart[]

  @@index([userId, isDeleted])
  @@index([dataSourceId])
}

model PublishedChart {
  /// Published chart primary key, generated by cuid.
  id           String        @id @default(cuid())
  /// Source project id.
  projectId    String
  /// Owner user id.
  userId       String
  /// Public share slug used in URLs.
  slug         String        @unique
  /// Share page title.
  title        String
  /// Optional share page description.
  description  String?
  /// Access control mode for the shared chart.
  access       PublishAccess @default(PUBLIC)
  /// Public visibility flag.
  isPublic     Boolean       @default(true)
  /// Optional password hash when access is password protected.
  passwordHash String?
  /// Immutable snapshot JSON used for public rendering.
  snapshotJson Json
  /// Number of share page views.
  viewCount    Int           @default(0)
  /// Record creation time.
  createdAt    DateTime      @default(now())
  /// Record last update time, maintained by Prisma.
  updatedAt    DateTime      @updatedAt
  /// Time the project was published.
  publishedAt  DateTime?     @default(now())
  /// Owning user relation.
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// Source project relation.
  project      ChartProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([slug])
}

model BillingEvent {
  /// Billing event primary key, generated by cuid.
  id           String           @id @default(cuid())
  /// Owner user id.
  userId       String
  /// Optional related membership id.
  membershipId String?
  /// Billing event category.
  eventType    BillingEventType
  /// Raw billing payload or provider event body.
  payloadJson  Json?
  /// Record creation time.
  createdAt    DateTime         @default(now())
  /// Owning user relation.
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// Optional related membership relation.
  membership   Membership?      @relation(fields: [membershipId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([membershipId])
}
