generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MembershipPlan {
  FREE
  PRO
  TEAM
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  CANCELED
  TRIALING
}

enum SourceType {
  NOTION
}

enum PublishAccess {
  PUBLIC
  PASSWORD
  PRIVATE
}

enum BillingEventType {
  MEMBERSHIP_CREATED
  MEMBERSHIP_UPDATED
  MEMBERSHIP_CANCELED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  MANUAL_GRANT
}

model User {
  /// User primary key, generated by cuid.
  id              String           @id @default(cuid())
  /// External auth provider user id, reserved for future auth integration.
  authUserId      String           @unique
  /// User email address, unique in the system.
  email           String           @unique
  /// Display name shown in product UI.
  name            String?
  /// Avatar image URL.
  avatar          String?
  /// Preferred timezone used for scheduling and display.
  timezone        String?          @default("Asia/Shanghai")
  /// Preferred locale used for UI and formatting.
  locale          String?          @default("zh-CN")
  /// Record creation time.
  createdAt       DateTime         @default(now())
  /// Record last update time, maintained by Prisma.
  updatedAt       DateTime         @updatedAt
  /// Membership records owned by the user.
  memberships     Membership[]
  /// Chart projects created by the user.
  projects        ChartProject[]
  /// Notion source bindings owned by the user.
  notionSources   NotionSource[]
  /// Published share records created by the user.
  publishedCharts PublishedChart[]
  /// Billing and membership event logs for the user.
  billingEvents   BillingEvent[]
}

model Membership {
  /// Membership primary key, generated by cuid.
  id          String            @id @default(cuid())
  /// Owner user id.
  userId      String
  /// Subscription plan type.
  plan        MembershipPlan    @default(FREE)
  /// Current membership lifecycle status.
  status      MembershipStatus  @default(ACTIVE)
  /// Membership effective start time.
  startAt     DateTime          @default(now())
  /// Membership end time when expired or canceled.
  endAt       DateTime?
  /// Extra billing or plan metadata stored as JSON.
  metaJson    Json?
  /// Record creation time.
  createdAt   DateTime          @default(now())
  /// Record last update time, maintained by Prisma.
  updatedAt   DateTime          @updatedAt
  /// Owning user relation.
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// Billing events associated with this membership.
  billingLogs BillingEvent[]

  @@index([userId, status])
}

model NotionSource {
  /// Notion source primary key, generated by cuid.
  id           String       @id @default(cuid())
  /// Owner user id.
  userId       String
  /// Shared Notion page id used as the source identifier.
  pageId       String
  /// Human-readable page title cached from Notion.
  pageTitle    String?
  /// Access mode description for the shared page.
  accessType   String?      @default("public-page")
  /// Raw source metadata cached from Notion.
  rawMetaJson  Json?
  /// Record creation time.
  createdAt    DateTime     @default(now())
  /// Record last update time, maintained by Prisma.
  updatedAt    DateTime     @updatedAt
  /// Owning user relation.
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// Projects bound to this Notion source.
  projects     ChartProject[]

  @@unique([userId, pageId])
  @@index([pageId])
}

model ChartProject {
  /// Project primary key, generated by cuid.
  id                 String            @id @default(cuid())
  /// Owner user id.
  userId             String
  /// Optional bound Notion source id.
  notionSourceId     String?
  /// Project display name.
  name               String
  /// Optional project description.
  description        String?
  /// Data source type for the project.
  sourceType         SourceType        @default(NOTION)
  /// Redundant cached Notion page id for simpler querying.
  notionPageId       String?
  /// Current chart type used by the project.
  chartType          String
  /// Core chart specification/configuration JSON.
  configJson         Json
  /// Optional chart theme configuration JSON.
  themeJson          Json?
  /// Optional publish settings JSON.
  publishOptionsJson Json?
  /// Soft delete flag.
  isDeleted          Boolean           @default(false)
  /// Record creation time.
  createdAt          DateTime          @default(now())
  /// Record last update time, maintained by Prisma.
  updatedAt          DateTime          @updatedAt
  /// Owning user relation.
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// Optional Notion source relation.
  notionSource       NotionSource?     @relation(fields: [notionSourceId], references: [id], onDelete: SetNull)
  /// Published share records generated from this project.
  publishedCharts    PublishedChart[]

  @@index([userId, isDeleted])
  @@index([notionPageId])
}

model PublishedChart {
  /// Published chart primary key, generated by cuid.
  id           String        @id @default(cuid())
  /// Source project id.
  projectId    String
  /// Owner user id.
  userId       String
  /// Public share slug used in URLs.
  slug         String        @unique
  /// Share page title.
  title        String
  /// Optional share page description.
  description  String?
  /// Access control mode for the shared chart.
  access       PublishAccess @default(PUBLIC)
  /// Public visibility flag.
  isPublic     Boolean       @default(true)
  /// Optional password hash when access is password protected.
  passwordHash String?
  /// Immutable snapshot JSON used for public rendering.
  snapshotJson Json
  /// Number of share page views.
  viewCount    Int           @default(0)
  /// Record creation time.
  createdAt    DateTime      @default(now())
  /// Record last update time, maintained by Prisma.
  updatedAt    DateTime      @updatedAt
  /// Time the project was published.
  publishedAt  DateTime?     @default(now())
  /// Owning user relation.
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// Source project relation.
  project      ChartProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([slug])
}

model BillingEvent {
  /// Billing event primary key, generated by cuid.
  id           String           @id @default(cuid())
  /// Owner user id.
  userId       String
  /// Optional related membership id.
  membershipId String?
  /// Billing event category.
  eventType    BillingEventType
  /// Raw billing payload or provider event body.
  payloadJson  Json?
  /// Record creation time.
  createdAt    DateTime         @default(now())
  /// Owning user relation.
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// Optional related membership relation.
  membership   Membership?      @relation(fields: [membershipId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([membershipId])
}
